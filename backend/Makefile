.PHONY: help run build test test-coverage lint migrate-up migrate-down migrate-create docker-up docker-down clean

# Variables
APP_NAME=sorteos-api
DOCKER_COMPOSE=docker-compose
MIGRATE=migrate
MIGRATIONS_PATH=./migrations
DB_URL=postgres://sorteos_user:sorteos_password@localhost:5432/sorteos_db?sslmode=disable

help: ## Mostrar ayuda
	@echo "Comandos disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

run: ## Ejecutar aplicaciÃ³n en desarrollo
	@echo "ğŸš€ Ejecutando $(APP_NAME)..."
	go run ./cmd/api

build: ## Compilar aplicaciÃ³n (directo a producciÃ³n)
	@echo "ğŸ”¨ Compilando $(APP_NAME)..."
	go build -o $(APP_NAME) ./cmd/api
	@echo "âœ… Binario creado: $(APP_NAME)"

test: ## Ejecutar tests
	@echo "ğŸ§ª Ejecutando tests..."
	go test -v -race ./...

test-coverage: ## Ejecutar tests con coverage
	@echo "ğŸ“Š Ejecutando tests con coverage..."
	go test -v -race -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage disponible en coverage.html"

lint: ## Ejecutar linter
	@echo "ğŸ” Ejecutando golangci-lint..."
	golangci-lint run

tidy: ## Limpiar dependencias
	@echo "ğŸ§¹ Limpiando dependencias..."
	go mod tidy

deps: ## Descargar dependencias
	@echo "ğŸ“¦ Descargando dependencias..."
	go mod download

migrate-up: ## Aplicar migraciones
	@echo "â¬†ï¸  Aplicando migraciones..."
	$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up

migrate-down: ## Revertir Ãºltima migraciÃ³n
	@echo "â¬‡ï¸  Revirtiendo Ãºltima migraciÃ³n..."
	$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down 1

migrate-create: ## Crear nueva migraciÃ³n (usar: make migrate-create name=nombre_migracion)
	@if [ -z "$(name)" ]; then \
		echo "âŒ Error: Debes especificar name=nombre_migracion"; \
		exit 1; \
	fi
	@echo "ğŸ“ Creando migraciÃ³n: $(name)"
	$(MIGRATE) create -ext sql -dir $(MIGRATIONS_PATH) -seq $(name)

migrate-force: ## Forzar versiÃ³n de migraciÃ³n (usar: make migrate-force version=1)
	@if [ -z "$(version)" ]; then \
		echo "âŒ Error: Debes especificar version=N"; \
		exit 1; \
	fi
	@echo "âš ï¸  Forzando versiÃ³n $(version)..."
	$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" force $(version)

docker-up: ## Levantar contenedores Docker
	@echo "ğŸ³ Levantando contenedores..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ… Contenedores activos. Esperando 5s..."
	@sleep 5

docker-down: ## Detener contenedores Docker
	@echo "ğŸ›‘ Deteniendo contenedores..."
	$(DOCKER_COMPOSE) down

docker-logs: ## Ver logs de contenedores
	$(DOCKER_COMPOSE) logs -f

docker-rebuild: ## Reconstruir contenedores
	@echo "ğŸ”„ Reconstruyendo contenedores..."
	$(DOCKER_COMPOSE) up -d --build

clean: ## Limpiar archivos generados
	@echo "ğŸ§¹ Limpiando..."
	rm -f coverage.out coverage.html
	rm -rf tmp/
	@echo "âœ… Limpieza completada"

install-tools: ## Instalar herramientas de desarrollo
	@echo "ğŸ”§ Instalando herramientas..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "âœ… Herramientas instaladas"

dev: docker-up migrate-up run ## Iniciar entorno de desarrollo completo

.DEFAULT_GOAL := help
